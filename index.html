<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的自訂首頁</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

    <div class="page-header">
        <div class="header-left-panel">
            <h1>過勞儀表板</h1>
            <div id="datetime-container">
                <div class="split-flap-display" id="split-flap-display"></div>
            </div>
            <div class="icon-group">
                <div id="music-toggle-button" class="music-icon-container" title="播放/暫停背景音樂">
                    <i class="fa-solid fa-music"></i>
                </div>
                <div id="quote-toggle-button" class="quote-icon-container" title="顯示/隱藏每日名言">
                    <i class="fa-solid fa-quote-left"></i>
                </div>
            </div>
        </div>
        <div class="header-right-panel">
            <a href="https://karolushi.netlify.app" class="header-link">楊時綱律師</a>
        </div>
    </div>

    <div class="marquee-container" id="marquee-container">
        <p class="marquee-text" id="marquee-text-dynamic"></p>
    </div>

    <a href="https://karolushi.netlify.app" class="mobile-home-link">前往 楊時綱律師 個人網站</a>

    <nav id="quick-nav" class="quick-nav-container"></nav>

    <header class="search-header">
        <div class="search-container">
            <form id="google-search-form" class="search-form">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="在 Google 上搜尋，或輸入一個網址" autocomplete="off">
                </div>
                <button type="submit" style="display: none;">搜尋</button>
            </form>
            <form id="lawbank-search-form" class="search-form">
                <div class="search-box">
                    <i class="fa-solid fa-book-atlas search-icon"></i>
                    <input type="text" id="lawbank-search-input" class="search-input" placeholder="在法源六法上搜尋" autocomplete="off">
                </div>
                <button type="submit" style="display: none;">搜尋</button>
            </form>
        </div>
    </header>

    <main class="container">
        <div id="link-container"></div>
    </main>

    <div class="floating-panel">
        <a href="tool.html" target="_blank" class="panel-button" title="文章整理小幫手">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span class="panel-text">文章整理小幫手</span>
        </a>
        <a href="judgment_tool.html" target="_blank" class="panel-button panel-button-alt" title="判決摘錄小工具">
            <i class="fa-solid fa-file-invoice"></i>
            <span class="panel-text">判決摘錄小工具</span>
        </a>
        <a href="https://touchstorm.netlify.app/" target="_blank" class="panel-button panel-button-warning" title="即時法律新聞">
            <i class="fa-solid fa-newspaper"></i>
            <span class="panel-text">即時法律新聞</span>
        </a>
        <a href="#" id="open-calculator-btn" class="panel-button" style="background-color: #5bc0de;" title="簡易計算機">
            <i class="fa-solid fa-calculator"></i>
            <span class="panel-text">簡易計算機</span>
        </a>
        <a href="#" id="open-player-btn" class="panel-button" style="background-color: #6c5ce7;" title="線上音訊播放器">
            <i class="fa-solid fa-headphones-simple"></i>
            <span class="panel-text">線上音訊播放器</span>
        </a>
    </div>

    <a href="#" id="back-to-top-btn" class="back-to-top-btn">
        <i class="fa-solid fa-arrow-up"></i>
        <span>回到最上</span>
    </a>

    <footer class="page-footer">
        © 2024 楊時綱. All Rights Reserved.
    </footer>

    <div id="calculator-modal" class="calculator-modal">
        <div class="calculator-modal-content">
            <header class="calculator-header">
                <span id="close-calculator-btn" class="calculator-close-btn">×</span>
            </header>
            <div class="calculator-body">
                <div class="calculator-display">
                    <div id="calculator-expression" class="calculator-expression"></div>
                    <div id="calculator-result" class="calculator-result">0</div>
                </div>
                <div class="calculator-buttons">
                     <button class="btn-op-light">C</button><button class="btn-op-light">(</button><button class="btn-op-light">)</button><button class="btn-op-light">DEL</button>
                    <button>7</button><button>8</button><button>9</button><button class="btn-op">÷</button>
                    <button>4</button><button>5</button><button>6</button><button class="btn-op">×</button>
                    <button>1</button><button>2</button><button>3</button><button class="btn-op">-</button>
                    <button>0</button><button>.</button><button class="btn-op-light">%</button><button class="btn-op">+</button>
                    <button class="btn-equal span-4">=</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="player-modal" class="player-modal">
        <div class="player-modal-content">
            <header class="player-header">
                <h3><i class="fa-solid fa-tower-broadcast"></i> 線上音訊</h3>
                <span id="close-player-btn" class="player-close-btn">×</span>
            </header>
            <div class="player-body">
                <div class="player-toggle">
                    <input type="checkbox" id="player-mode-toggle" class="player-mode-checkbox">
                    <label for="player-mode-toggle" class="toggle-label toggle-radio">廣播電台</label>
                    <label for="player-mode-toggle" class="toggle-label toggle-podcast">Podcast</label>
                    <div class="toggle-slider"></div>
                </div>
                <div class="player-controls">
                    <div class="select-wrapper">
                        <select id="player-show-select" class="player-select"></select>
                    </div>
                    <div class="select-wrapper" id="episode-select-wrapper" style="display: none;">
                        <select id="player-episode-select" class="player-select"></select>
                    </div>
                </div>
                <div class="player-main-area">
                    <audio id="main-audio-player" controls preload="metadata"></audio>
                </div>
                <div id="player-loading-indicator" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p>正在載入 Podcast 節目單...</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="background-audio" preload="auto"></audio>

    <script src="links.js"></script>
    
    <!-- ▼▼▼【已重構】單一、整合的 JavaScript 程式碼區塊 ▼▼▼ -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- 模組一：頁面通用邏輯 (跑馬燈、時鐘、背景音樂) ---
        const PageLogic = {
            init: function() {
                this.initQuoteMarquee();
                this.initSplitFlapClock();
                this.initBackgroundMusic();
            },

            initQuoteMarquee: function() {
                const quoteToggleButton = document.getElementById('quote-toggle-button');
                const marqueeContainer = document.getElementById('marquee-container');
                const marqueeText = document.getElementById('marquee-text-dynamic');
                if (!quoteToggleButton || !marqueeContainer || !marqueeText) return;

                let isQuoteVisible = false;
                let isFetching = false;

                const fetchAndSetQuote = async () => {
                    if (isFetching) return;
                    isFetching = true;
                    marqueeText.textContent = '每日名言載入中...';
                    try {
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://zenquotes.io/api/random')}`;
                        const response = await fetch(proxyUrl, { cache: 'no-cache' });
                        if (!response.ok) throw new Error('名言API請求失敗');
                        const data = JSON.parse((await response.json()).contents);
                        const { q: englishQuote, a: author } = data[0];
                        const translateUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(englishQuote)}&langpair=en|zh-TW`;
                        const translateResponse = await fetch(translateUrl);
                        const translateData = await translateResponse.json();
                        marqueeText.textContent = `"${englishQuote}" (${translateData.responseData.translatedText}) — ${author}`;
                    } catch (error) {
                        console.error('抓取名言時發生錯誤:', error);
                        marqueeText.textContent = '讀取每日名言失敗。 "The journey of a thousand miles begins with a single step." — Lao Tzu';
                    } finally {
                        isFetching = false;
                    }
                };
                
                quoteToggleButton.addEventListener('click', async () => {
                    isQuoteVisible = !isQuoteVisible;
                    quoteToggleButton.classList.toggle('active', isQuoteVisible);
                    marqueeContainer.classList.toggle('is-visible', isQuoteVisible);
                    if (isQuoteVisible) {
                        await fetchAndSetQuote();
                    }
                });
            },

            initSplitFlapClock: function() {
                const display = document.getElementById('split-flap-display');
                if (!display) return;
                let previousString = '';

                function update() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const weekdays = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
                    const weekday = weekdays[now.getDay()];
                    const newString = `${year}年 ${month}月${day}日 (${weekday}) ${hours}:${minutes}`;

                    if (newString !== previousString) {
                        display.innerHTML = newString.split('').map(char => `<span class="char">${char === ' ' ? ' ' : char}</span>`).join('');
                        previousString = newString;
                    }
                }
                setInterval(update, 1000);
                update();
            },

            initBackgroundMusic: function() {
                const musicToggleButton = document.getElementById('music-toggle-button');
                const audioPlayer = document.getElementById('background-audio');
                if (!musicToggleButton || !audioPlayer) return;
                
                const playlist = [
                    'music/background-music-calm-soft-340445.mp3',
                    'music/background-music-soft-calm-336543.mp3',
                ];
                let currentTrackIndex = 0;
                if(playlist.length > 0) audioPlayer.src = playlist[currentTrackIndex];

                musicToggleButton.addEventListener('click', () => {
                    if (playlist.length === 0) return;
                    audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
                });
                audioPlayer.addEventListener('ended', () => {
                    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                    audioPlayer.src = playlist[currentTrackIndex];
                    audioPlayer.play();
                });
                audioPlayer.onplaying = () => musicToggleButton.classList.add('playing');
                audioPlayer.onpause = () => musicToggleButton.classList.remove('playing');
            }
        };
        PageLogic.init();

        // --- 模組二：計算機邏輯 ---
        const Calculator = {
            init: function() {
                this.modal = document.getElementById('calculator-modal');
                this.openBtn = document.getElementById('open-calculator-btn');
                this.closeBtn = document.getElementById('close-calculator-btn');
                this.expressionDisplay = document.getElementById('calculator-expression');
                this.resultDisplay = document.getElementById('calculator-result');
                this.buttons = document.querySelector('.calculator-buttons');
                if (!this.modal || !this.openBtn) return;
                this.expression = '';
                this.isResultDisplayed = false;
                this.addEventListeners();
            },
            addEventListeners: function() {
                this.openBtn.addEventListener('click', e => { e.preventDefault(); this.modal.style.display = 'block'; });
                this.closeBtn.addEventListener('click', () => this.modal.style.display = 'none');
                window.addEventListener('click', e => { if (e.target == this.modal) this.modal.style.display = 'none'; });
                this.buttons.addEventListener('click', e => this.handleButtonPress(e));
            },
            handleButtonPress: function(e) {
                if (!e.target.matches('button')) return;
                const key = e.target.textContent;
                if (!isNaN(key) || key === '.') { this.appendCharacter(key); }
                else if ('+-×÷()'.includes(key)) { this.appendCharacter(key); }
                else if (key === '%') { this.appendCharacter(key); }
                else if (key === 'C') { this.clearAll(); }
                else if (key === 'DEL') { this.deleteLast(); }
                else if (key === '=') { this.calculateFinal(); }
            },
            appendCharacter: function(char) {
                if (this.isResultDisplayed) {
                    if (!'+-×÷%'.includes(char)) this.expression = '';
                    this.isResultDisplayed = false;
                }
                this.expression += char;
                this.updateDisplay();
            },
            updateDisplay: function() {
                this.expressionDisplay.textContent = this.expression.replace(/\*/g, '×').replace(/\//g, '÷');
            },
            calculateFinal: function() {
                try {
                    const sanitizedExpr = this.expression.replace(/×/g, '*').replace(/÷/g, '/');
                    const result = new Function('return ' + sanitizedExpr)();
                    this.resultDisplay.textContent = Math.round(result * 1e12) / 1e12;
                    this.expression = String(result);
                } catch {
                    this.resultDisplay.textContent = '錯誤';
                    this.expression = '';
                }
                this.isResultDisplayed = true;
                this.updateDisplay();
            },
            clearAll: function() {
                this.expression = '';
                this.expressionDisplay.textContent = '';
                this.resultDisplay.textContent = '0';
                this.isResultDisplayed = false;
            },
            deleteLast: function() {
                if(this.isResultDisplayed) return;
                this.expression = this.expression.slice(0, -1);
                this.updateDisplay();
            }
        };
        Calculator.init();

        // --- 模組三：線上音訊播放器邏輯 ---
        const AudioPlayer = {
            // 資料庫
            radioData: [
                { name: "中廣新聞網", url: "https://hls.mediaspot.cc/bcc_news/smil:bcc_news.smil/playlist.m3u8", type: "hls" },
                { name: "News98 新聞網", url: "https://broadcast.news98.com.tw/audio/98news", type: "direct" },
                { name: "飛碟電台", url: "https://hls.media.stream.live/hls/uforadiolive/live/playlist.m3u8", type: "hls" },
                { name: "警察廣播電台 (全國)", url: "https://hls.gov.taipei/live/pbs/playlist.m3u8", type: "hls" },
                { name: "POP Radio 台北流行廣播", url: "https://hichannel.hinet.net/live/pool/149/hls/live.m3u8", type: "hls" },
                { name: "環宇廣播電台", url: "https://cast.und.com.tw/967", type: "direct" },
                { name: "Hit FM 聯播網", url: "https://s2.rcs.revma.com/1st3r02anx8uv", type: "direct" },
                { name: "中廣音樂網 iRadio", url: "https://hls.mediaspot.cc/bcc_imusic/smil:bcc_imusic.smil/playlist.m3u8", type: "hls" },
                { name: "KISS Radio", url: "https://kissradio.tw.prod.boltdns.net/hls/live/2022837/971CH01/master.m3u8", type: "hls" },
                { name: "Apple Line 蘋果線上", url: "https://media.apple-line.com/appleline.mp3", type: "direct" },
                { name: "Best Radio 好事聯播網", url: "https://s4.rcs.revma.com/ypqt590xwz8uv", type: "direct" },
                { name: "Asia FM 亞太電台", url: "https://stream.asiafm.com.tw/asiafm_web", type: "direct" },
                { name: "ICRT", url: "https://live.icrt.com.tw/live", type: "direct" },
                { name: "Classical FM 97.7 古典音樂台", url: "https://live.classical-radio.com.tw/live", type: "direct" },
                { name: "Bravo FM 91.3 (台北都會音樂台)", url: "https://onair.bravo913.com.tw/BravoRadio", type: "direct" },
                { name: "國立教育廣播電臺 (臺北)", url: "https://hls.ner.gov.tw/live/ner/playlist.m3u8", type: "hls" },
                { name: "中央廣播電臺 (國語)", url: "https://livestream.rti.org.tw/hls-live/live/stream1/playlist.m3u8", type: "hls" },
                { name: "台北廣播電台 (FM 93.1)", url: "https://hls.gov.taipei/live/Tpeg/playlist.m3u8", type: "hls" },
                { name: "高雄廣播電台 (FM 94.3)", url: "https://hls.kbs.gov.tw/KbsLive/_definst_/KbsLive/playlist.m3u8", type: "hls" },
                { name: "寶島新聲", url: "https://live.superfm98-5.com.tw/superfm985", type: "direct" }
            ],
            podcastData: [
                { category: "法律與時事", name: "法客電台 by 法客 Fank", rssUrl: "https://rss.soundon.fm/podcasts/4222a088-722a-4467-941d-3b566537b8d7" },
                { category: "法律與時事", name: "法律白話文運動", rssUrl: "https://feeds.soundon.fm/podcasts/110924d5-4ac1-43b3-85e6-75f284457f5c" },
                { category: "法律與時事", name: "瑩真律師", rssUrl: "https://feeds.soundon.fm/podcasts/3506c257-22d7-4861-a53b-0105b4e311a2" },
                { category: "法律與時事", name: "雞蛋糕律師aka說書人", rssUrl: "https://feeds.soundon.fm/podcasts/7e299615-5592-4742-99b9-d102be8d1c7c" },
                { category: "法律與時事", name: "法律敲敲門", rssUrl: "https://feeds.soundon.fm/podcasts/b70ba5e6-126a-493a-8b1b-c1212b1a0300" },
                { category: "法律與時事", name: "敏迪選讀", rssUrl: "https://feeds.soundon.fm/podcasts/f233b8a8-e43b-47e4-b778-a261c15d436f" },
                { category: "法律與時事", name: "百靈果 News", rssUrl: "https://feeds.soundon.fm/podcasts/8c138760-b396-444a-a032-5c326e0b73c4.xml" },
                { category: "職場與技能", name: "大人的 Small Talk", rssUrl: "https://feeds.soundon.fm/podcasts/116235b6-a212-42a9-8743-a1c1ac40b37e" },
                { category: "職場與技能", name: "佐編茶水間 (Zoey)", rssUrl: "https://rss.soundon.fm/podcasts/02a99d68-7552-472e-8a21-be4f2d3714b6" },
                { category: "職場與技能", name: "星箭廣播", rssUrl: "https://feeds.simplecast.com/7r1T0kI1" },
                { category: "職場與技能", name: "最近工作還好嗎", rssUrl: "https://feeds.soundon.fm/podcasts/8a68b726-24e5-4f7f-8636-a36c92d506f3" },
                { category: "職場與技能", name: "PM大小事", rssUrl: "https://feeds.soundon.fm/podcasts/f6d74702-835c-4a33-9118-87a329c66e2c" },
                { category: "職場與技能", name: "讓思想去旅行", rssUrl: "https://feeds.soundon.fm/podcasts/983942b0-8c2a-4847-a864-779836173d1f" },
                { category: "人資與管理", name: "人資主管UP學", rssUrl: "https://open.firstory.me/rss/user/ckg4zvea5628208759j1ksmg6" },
                { category: "人資與管理", name: "一談就贏：Alex 的談判學", rssUrl: "https://feeds.soundon.fm/podcasts/88563335-d218-4a6c-941f-a5f36e8b4e76" },
                { category: "人資與管理", name: "Vista寫作陪伴計畫", rssUrl: "https://feeds.soundon.fm/podcasts/11f005a3-71a2-4752-b43d-6b5ec63046f4" },
                { category: "人資與管理", name: "BFA 簡報編輯室", rssUrl: "https://feeds.soundon.fm/podcasts/3b5a1b3c-11dc-4a7b-a48e-0f738a08d9f4" },
                { category: "綜合熱門", name: "台灣通勤第一品牌", rssUrl: "https://feeds.soundon.fm/podcasts/122f8773-a8b9-4f51-9e7f-055365559c73.xml" },
                { category: "綜合熱門", name: "聽天下：天下雜誌", rssUrl: "https://storage.googleapis.com/cw-podcast-rss-feed/cw_podcast_all.xml" },
                { category: "綜合熱門", name: "吳淡如人生實用商學院", rssUrl: "https://feeds.soundon.fm/podcasts/c3912a76-9280-485a-a82f-2d6f8f17049c.xml" },
                { category: "綜合熱門", name: "好味小姐開束縛我還你原形", rssUrl: "https://feeds.soundon.fm/podcasts/a59025e1-feb7-4584-a15e-a6a9644f6f26.xml" },
                { category: "綜合熱門", name: "從前從前", rssUrl: "https://feeds.soundon.fm/podcasts/a4dc689b-f111-468a-8534-75c13e4b7501.xml" },
                { category: "綜合熱門", name: "呱吉", rssUrl: "https://feeds.soundon.fm/podcasts/2ea60017-d586-4444-a55e-4b6b6c0e532b.xml" },
                { category: "投資理財", name: "Gooaye 股癌", rssUrl: "https://feeds.soundon.fm/podcasts/a111f0a8-f472-4809-84b2-a421a2b25547.xml" },
                { category: "投資理財", name: "M觀點", rssUrl: "https://feeds.soundon.fm/podcasts/e3bc0062-a4a9-4786-8a03-c6f31f77d3f8" },
                { category: "投資理財", name: "財報狗", rssUrl: "https://feeds.soundon.fm/podcasts/8fa97672-2357-4228-a3f2-11c070c7329b" },
                { category: "投資理財", name: "美股K線 anchored on Hope", rssUrl: "https://feeds.soundon.fm/podcasts/c9c48858-a56f-4221-8207-3382c7a70196" },
                { category: "投資理財", name: "MacroMicro 財經M平方", rssUrl: "https://feeds.soundon.fm/podcasts/b52382c4-8067-4217-862d-9475949d11fc" },
                { category: "投資理財", name: "JC財經觀點", rssUrl: "https://feeds.soundon.fm/podcasts/1105e1a1-9492-4914-a58d-7582ba95955e" },
                { category: "投資理財", name: "游庭皓的財經皓角", rssUrl: "https://feeds.soundon.fm/podcasts/1e58a785-f55a-4e20-95b6-7647240a5e8e" },
            ],

            // 初始化
            init: function() {
                this.cacheDOMElements();
                this.hls = null;
                this.currentMode = 'radio';
                this.bindEvents();
                this.updateUIForMode(this.currentMode);
            },

            // 快取 DOM 元素
            cacheDOMElements: function() {
                this.modal = document.getElementById('player-modal');
                this.openBtn = document.getElementById('open-player-btn');
                this.closeBtn = document.getElementById('close-player-btn');
                this.modeToggle = document.getElementById('player-mode-toggle');
                this.showSelect = document.getElementById('player-show-select');
                this.episodeSelect = document.getElementById('player-episode-select');
                this.episodeWrapper = document.getElementById('episode-select-wrapper');
                this.audioPlayer = document.getElementById('main-audio-player');
                this.loadingIndicator = document.getElementById('player-loading-indicator');
            },
            
            // 綁定所有事件
            bindEvents: function() {
                this.openBtn.addEventListener('click', (e) => { e.preventDefault(); this.open(); });
                this.closeBtn.addEventListener('click', () => this.close());
                this.modal.addEventListener('click', (e) => { if (e.target === this.modal) this.close(); });
                this.modeToggle.addEventListener('change', () => this.handleModeChange());
                this.showSelect.addEventListener('change', (e) => this.handleShowChange(e));
                this.episodeSelect.addEventListener('change', (e) => this.handleEpisodeChange(e));
            },

            // 事件處理函式
            handleModeChange: function() {
                this.updateUIForMode(this.modeToggle.checked ? 'podcast' : 'radio');
            },
            handleShowChange: function(e) {
                const selectedValue = e.target.value;
                if (!selectedValue) {
                    this.stop();
                    if(this.currentMode === 'podcast') this.episodeSelect.innerHTML = '';
                    return;
                }
                if (this.currentMode === 'radio') {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const type = selectedOption.dataset.type;
                    this.play(selectedValue, type);
                } else {
                    this.fetchAndParseRSS(selectedValue);
                }
            },
            handleEpisodeChange: function(e) {
                const mp3Url = e.target.value;
                if (mp3Url) {
                    this.play(mp3Url, 'direct');
                } else {
                    this.stop();
                }
            },

            // 核心功能函式
            open: function() { this.modal.classList.add('is-visible'); },
            close: function() { this.modal.classList.remove('is-visible'); this.stop(); },
            stop: function() {
                this.audioPlayer.pause();
                this.audioPlayer.src = "";
                if (this.hls) {
                    this.hls.destroy();
                    this.hls = null;
                }
            },
            play: function(url, type) {
                this.stop();
                console.log(`Attempting to play: ${url} (type: ${type})`);
                if (type === 'hls') {
                    this.playHls(url);
                } else {
                    this.playDirect(url);
                }
            },
            playDirect: function(url) {
                this.audioPlayer.src = url;
                this.audioPlayer.play().catch(e => console.error("Direct Playback Error:", e));
            },
            playHls: function(url) {
                if (Hls.isSupported()) {
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.audioPlayer);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        this.audioPlayer.play().catch(e => console.error("HLS Playback Error:", e));
                    });
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS.js Error:', data.type, ' - ', data.details);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR: this.hls.startLoad(); break;
                                case Hls.ErrorTypes.MEDIA_ERROR: this.hls.recoverMediaError(); break;
                                default: this.hls.destroy(); break;
                            }
                        }
                    });
                } else if (this.audioPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    this.playDirect(url); // Native HLS support
                }
            },

            // UI 更新與資料處理
            updateUIForMode: function(mode) {
                this.currentMode = mode;
                this.stop();
                this.episodeSelect.innerHTML = '';
                if (mode === 'radio') {
                    this.episodeWrapper.style.display = 'none';
                    this.populateSelect(this.showSelect, this.radioData, 'url', 'name');
                } else {
                    this.episodeWrapper.style.display = 'block';
                    this.populateSelect(this.showSelect, this.podcastData, 'rssUrl', 'name');
                }
            },
            populateSelect: function(selectElement, data, valueKey, textKey) {
                selectElement.innerHTML = `<option value="">--- 請選擇 ---</option>`;
                if (data.length > 0 && data[0].category) {
                    let currentGroup = null;
                    let optgroupElement = null;
                    data.forEach(item => {
                        if (item.category !== currentGroup) {
                            currentGroup = item.category;
                            optgroupElement = document.createElement('optgroup');
                            optgroupElement.label = currentGroup;
                            selectElement.appendChild(optgroupElement);
                        }
                        const option = document.createElement('option');
                        option.value = item[valueKey];
                        option.textContent = item[textKey];
                        if (optgroupElement) optgroupElement.appendChild(option);
                    });
                } else {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueKey];
                        option.textContent = item[textKey];
                        if (item.type) option.dataset.type = item.type;
                        selectElement.appendChild(option);
                    });
                }
            },
            fetchAndParseRSS: async function(rssUrl) {
                this.loadingIndicator.style.display = 'flex';
                this.episodeSelect.innerHTML = '<option>載入中...</option>';
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data.contents, "application/xml");
                    const items = xmlDoc.querySelectorAll('item');
                    const episodes = Array.from(items).map(item => ({
                        title: item.querySelector('title')?.textContent || '無標題',
                        url: item.querySelector('enclosure')?.getAttribute('url') || ''
                    })).filter(e => e.url);

                    this.populateSelect(this.episodeSelect, episodes, 'url', 'title');
                    if (episodes.length > 0) {
                        this.episodeSelect.selectedIndex = 1;
                        this.play(episodes[0].url, 'direct');
                    }
                } catch (error) {
                    console.error("RSS Fetch/Parse Error:", error);
                    this.episodeSelect.innerHTML = '<option>載入失敗</option>';
                } finally {
                    this.loadingIndicator.style.display = 'none';
                }
            }
        };
        AudioPlayer.init();

    });
    </script>
    <!-- ▲▲▲【重構結束】▲▲▲ -->

</body>
</html>